name: Terraform Pipeline

on:
  workflow_call:
    outputs:
      instance_id:
        description: "ID da instÃ¢ncia EC2 (SSM)"
        value: ${{ jobs.terraform.outputs.instance_id }}
      db_endpoint:
        description: "Endpoint of the database"
        value: ${{ jobs.terraform.outputs.db_endpoint }}
      db_port:
        description: "Port of the database"
        value: ${{ jobs.terraform.outputs.db_port }}     

permissions:
  id-token: write 
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      instance_id: ${{ steps.outputs.outputs.instance_id }}
      db_endpoint: ${{ steps.outputs.outputs.db_endpoint }}
      db_port: ${{ steps.outputs.outputs.db_port }}      

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1  

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Debug Terraform module files
        run: |
          echo "github.sha=${{ github.sha }}"
          pwd
          ls -la
          ls -la terraform
          echo "--- terraform/main.tf ---"
          sed -n '1,220p' terraform/main.tf
          echo "--- terraform/outputs.tf ---"
          sed -n '1,120p' terraform/outputs.tf

      - name: Terraform init
        run: terraform -chdir=terraform init -reconfigure

      - name: Terraform validate
        run: terraform -chdir=terraform validate

      - name: Terraform plan
        env:
          TF_VAR_cdirs_acesso_remoto: ${{ secrets.REMOTE_ACCESS_CIDR }}
          TF_VAR_s3_deploy_bucket: ${{ secrets.S3_DEPLOY_BUCKET }}
          TF_VAR_db_name: ${{ secrets.DB_NAME }}
        run: terraform -chdir=terraform plan -out=tfplan
      
      - name: Terraform apply
        run: terraform -chdir=terraform apply -auto-approve tfplan

      - name: Collect outputs
        id: outputs
        run: |
          instance=$(terraform -chdir=terraform output -raw ec2_instance_id)
          echo "instance_id=$instance" >> $GITHUB_OUTPUT
          
          db_endpoint=$(terraform -chdir=terraform output -raw db_endpoint)
          echo "db_endpoint=$db_endpoint" >> $GITHUB_OUTPUT
          
          db_port=$(terraform -chdir=terraform output -raw db_port)
          echo "db_port=$db_port" >> $GITHUB_OUTPUT        